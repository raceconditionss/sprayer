name: Sprayer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Cada instância terá um IP diferente do GitHub Actions
        instance: [1, 2, 3, 4, 5]
      max-parallel: 5  # Executar simultaneamente
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git
      
      - name: Clone Thermoptic
        run: |
          git clone https://github.com/mandatoryprogrammer/thermoptic.git
          cd thermoptic
      
      - name: Install Thermoptic dependencies
        run: |
          cd thermoptic
          python3 -m pip install -r requirements.txt
      
      - name: Install sprayer dependencies
        run: python3 -m pip install -r requirements.txt
      
      - name: Start Thermoptic proxy in background
        run: |
          cd thermoptic
          # Inicia o proxy na porta 8080
          nohup python3 thermoptic.py --port 8080 > thermoptic.log 2>&1 &
          sleep 5  # Aguarda o proxy iniciar
          echo "Thermoptic proxy iniciado"
      
      - name: Verify proxy is running
        run: |
          curl -x http://127.0.0.1:8080 -I https://www.google.com || echo "Proxy check failed"
      
      - name: Run sprayer script
        run: python sprayer.py
        env:
          USERNAMES: ${{ secrets.USERNAMES }}
          PASSWORD: ${{ secrets.PASSWORD }}
          CATCHERURL: ${{ secrets.CATCHERURL }}
          CATCHERTLS: ${{ secrets.CATCHERTLS }}
          PROXY_HOST: "127.0.0.1"
          PROXY_PORT: "8080"
          INSTANCE_ID: ${{ matrix.instance }}
      
      - name: Show Thermoptic logs (on failure)
        if: failure()
        run: |
          echo "=== Thermoptic Logs ==="
          cat thermoptic/thermoptic.log || echo "No logs found"
